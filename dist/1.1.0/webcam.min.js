"use strict";!function(){navigator.getMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,window.hasUserMedia=function(){return navigator.getMedia?!0:!1}}(),angular.module("webcam",[]).directive("webcam",["$window",function(){return{template:'<div class="webcam"></div>',restrict:"E",replace:!0,transclude:!0,scope:{onError:"&",onStarted:"&",onStreaming:"&",onGotBytearray:"&",getBytearray:"=?",placeholder:"=",streamWidth:"=",streamHeight:"=",elementWidth:"=",elementHeight:"=",facing:"=",fps:"="},link:function(a,b){a.onGotBytearray||(a.onGotBytearray=function(){}),a.getBytearray||(a.getBytearray=function(){});var c="jscam_canvas_only.swf",d="https://raw.githubusercontent.com/coryalder/Interface-Elements/master/camera_switch.png",e=10,f=null,g=null,h=null,i=null,j=null,k=null,l={hasWebRTC:!0,hasPlaceholder:!1,hasSwitchCamera:!1,fps:30,dims:{width:320,height:240}},m={isStreaming:!1,availableCameras:[],facing:{id:{front:-1,back:-1},"default":"back",hasFacing:function(){return!(-1==this.id.front&&-1==this.id.back)}},current:{id:0,stream:null,streamSpecs:{}},dims:{width:320,height:240}},n={aspectRatioElem:1,aspectRatioFeed:1,renderRect:null},o=function(){if(v(),!x())return l.hasWebRTC=!1,void u();var c=function(){if(w(),a.placeholder){var c=document.createElement("img");c.setAttribute("class","webcam-loader"),c.src=a.placeholder,b.append(c)}m.facing.hasFacing()&&(m.current.id=m.facing.id[m.facing.default]),z(m.current.id)};y(c)},p=function(){q(),g.remove()},q=function(){m.current.stream&&"function"==typeof m.current.stream.stop&&m.current.stream.stop(),f&&window.clearInterval(f)},r=function(){var a=m.current.id,b=m.availableCameras;a++,a>=b.length&&(a=0),z(a)};a.getBytearray=function(){if(!l.hasWebRTC)return void webcam.capture();var b=i.getContext("2d");b.drawImage(g,0,0,i.width,i.height);var c=b.getImageData(0,0,i.width,i.height).data;a.onGotBytearray&&a.onGotBytearray({data:s(c)})};var s=function(a){for(var b=new Uint8Array(a.length/4),c=0;c<a.length;c+=4)b[c>>2]=Math.floor(.2126*a[c]+.7152*a[c+1]+.0722*a[c+2]);return b},t=null,u=function(){function d(){for(var b=t.frame.split(";"),c=new Uint8Array(76800),d=1;d<b.length;d++){var h=f(e(b[d]));c[d]=g(h)}a.onGotBytearray&&(console.log("calling on Success ",webcam.onSuccess,c),a.onGotBytearray({data:c})),t.reset()}function e(a){var b=Number(a).toString(16);return b="000000".substr(0,6-b.length)+b}function f(a){var b=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a);return b?{r:parseInt(b[1],16),g:parseInt(b[2],16),b:parseInt(b[3],16)}:null}function g(a){return Math.floor(.2126*a.r+.7152*a.g+.0722*a.b)}t={row_counter:0,frame:"",reset:function(){this.row_counter=0,this.frame=""}},b.webcam({width:320,height:240,mode:"callback",swffile:c,onTick:function(){},onSave:function(a){t.frame+=a,t.row_counter++,t.row_counter>=240&&d()},onCapture:function(){webcam.save()},debug:function(b,c){"Camera started"==c?a.onStarted&&a.onStarted():("Flash movie not yet registered!"==c||"No camera was detected."==c)&&a.onError&&a.onError({err:"no camera available"})},onLoad:function(){}})},v=function(){a.streamWidth&&(m.dims.width=a.streamWidth),a.streamHeight&&(m.dims.height=a.streamHeight),a.elementWidth&&(l.dims.width=a.elementWidth),a.elementHeight&&(l.dims.height=a.elementHeight),!a.facing||"front"!==a.facing&&"back"!==a.facing||(m.facing.default=a.facing),a.fps&&(l.fps=a.fps),aspectRatioElem=l.dims.width/l.dims.height},w=function(){g=document.createElement("video"),g.setAttribute("class","webcam-live"),g.setAttribute("autoplay",""),i=document.createElement("canvas"),i.setAttribute("width",m.dims.width),i.setAttribute("height",m.dims.height),h=document.createElement("canvas"),h.setAttribute("width",l.dims.width),h.setAttribute("height",l.dims.height),h.onmousedown=E,b.append(h),l.hasSwitchCamera&&(k=document.createElement("img"),k.src=d)},x=function(){if(!window.hasUserMedia())return!1;var a="",b=!1;return navigator.webkitGetUserMedia&&(a=parseInt(navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./)[2],10),b=!0),navigator.mozGetUserMedia&&(a=parseInt(navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1],10),b=!0),a>=30&&1==b?!0:!1},y=function(a){function b(b){m.availableCameras=[];for(var c=0;c<b.length;c++)"audio"!==b[c].kind&&("user"===b[c].facing?m.facing.id.front=m.availableCameras.length:"environment"===b[c].facing&&(m.facing.id.back=m.availableCameras.length),m.availableCameras.push(b[c]));m.availableCameras.length>1&&(l.hasSwitchCamera=!0),a()}MediaStreamTrack.getSources(b)},z=function(a){var b=m.availableCameras;a="undefined"!=typeof a?a:0,(0>a||a>=b.length)&&(a=0);var c={};navigator.getUserMedia?c={video:{optional:[{sourceId:b[a].id}]}}:navigator.oGetUserMedia?c={video:{optional:[{sourceId:b[a].id}]}}:navigator.mozGetUserMedia?c={video:{optional:[{sourceId:b[a].id}]}}:navigator.webkitGetUserMedia?c={video:{optional:[{sourceId:b[a].id}]}}:navigator.msGetUserMedia&&(c={video:{optional:[{sourceId:b[a].id}]},audio:!1}),m.current.streamSpec=c,m.current.id=a,A(c)},A=function(b){var c=function(b){if(m.current.stream=b,navigator.mozGetUserMedia)g.mozSrcObject=b;else{var c=window.URL||window.webkitURL;g.src=c.createObjectURL(b)}g.play(),a.onStarted&&a.onStarted({stream:b,video:g}),f=setInterval(C,1e3/l.fps)},d=function(b){F(),console&&console.log&&console.log("The following error occured: ",b),a.onError&&a.onError({err:b})};m.current.stream&&q(),navigator.getMedia(b,c,d),g.addEventListener("canplay",function(){m.isStreaming||(n.aspectRatioFeed=g.videoWidth/g.videoHeight,n.aspectRatioFeed!=n.aspectRatioElem&&D(),m.isStreaming=!0,F(),a.onStreaming&&a.onStreaming({video:g}))},!1)},B=0,C=function(){if(m.isStreaming){g.videoWidth!=B&&(D(),B=g.videoWidth);var a=h.getContext("2d"),b=n.renderRect?n.renderRect:{x:0,y:0,width:h.width,height:h.height};a.drawImage(g,b.x,b.y,b.width,b.height),l.hasSwitchCamera&&a.drawImage(k,h.width-e-k.width,e)}},D=function(){if(n.aspectRatioFeed=g.videoWidth/g.videoHeight,n.aspectRatioFeed<n.aspectRatioElem){var a=l.dims.width/g.videoWidth,b=g.videoHeight*a,c=-(b-l.dims.height)/2;n.renderRect={x:0,y:c,width:l.dims.width,height:b}}else if(n.aspectRatioFeed>n.aspectRatioElem){var a=l.dims.height/g.videoHeight,d=g.videoWidth*a,e=-(d-l.dims.width)/2;n.renderRect={x:e,y:0,width:d,height:l.dims.height}}},E=function(a){if(l.hasSwitchCamera){var b=h.width-e-k.width,c=b+k.width,d=e,f=d+k.height;a.layerX>b&&a.layerX<c&&a.layerY>d&&a.layerY<f&&r()}},F=function(){j&&angular.element(j).remove()};a.$on("$destroy",q),a.$on("START_WEBCAM",o),a.$on("STOP_WEBCAM",p),o()}}}]);