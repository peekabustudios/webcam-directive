"use strict";!function(){navigator.getMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,window.hasUserMedia=function(){return navigator.getMedia?!0:!1}}(),angular.module("webcam",[]).directive("webcam",function(){return{template:'<div class="webcam" ng-transclude></div>',restrict:"E",replace:!0,transclude:!0,scope:{onError:"&",onStream:"&",onStreaming:"&",placeholder:"=",videoHeight:"=",videoWidth:"="},link:function(a,b){var c,d,e=[],f=-1,g=-1,h=!1,i=null,j=function(){d&&"function"==typeof d.stop&&d.stop(),c&&delete c.src},k=function(b){if(d=b,console.log(b),navigator.mozGetUserMedia)c.mozSrcObject=b;else{var e=window.URL||window.webkitURL;c.src=e.createObjectURL(b)}c.play(),a.onStream&&a.onStream({stream:b,video:c})},l=function(){console.log("removing loader"),i&&angular.element(i).remove()},m=function(b){l(),console&&console.log&&console.log("The following error occured: ",b),a.onError&&a.onError({err:b})},n=function(a){a="undefined"!=typeof a?a:0,"front"===a?a=f:"back"===a&&(a=g),console.log("message before validation"),(0>a||a>e.length-1)&&(a=0),console.log("message after validation");var b={};console.log("cameras : ",e,"using id : ",a),-1===a&&(a=0),navigator.getUserMedia?b={video:{optional:[{sourceId:e[a].id}]}}:navigator.oGetUserMedia?b={video:{optional:[{sourceId:e[a].id}]}}:navigator.mozGetUserMedia?b={video:{optional:[{sourceId:e[a].id}]}}:navigator.webkitGetUserMedia?b={video:{optional:[{sourceId:e[a].id}]}}:navigator.msGetUserMedia&&(b={video:{optional:[{sourceId:e[a].id}]},audio:!1}),console.log("camera spec",b),p(b)},o=function(){if(c=document.createElement("video"),c.setAttribute("class","webcam-live"),c.setAttribute("autoplay",""),b.append(c),a.placeholder){var d=document.createElement("img");d.setAttribute("class","webcam-loader"),d.src=a.placeholder,b.append(d)}var h=function(a){function b(b){e=[];for(var c=0;c<b.length;c++)"audio"!==b[c].kind&&(console.log(b[c]),alert(b[c].facing),"user"===b[c].facing?f=c:"environment"===b[c].facing&&(g=c),e.push(b[c]));a()}var c="";navigator.webkitGetUserMedia&&(c=parseInt(navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./)[2],10)),navigator.mozGetUserMedia&&(c=parseInt(navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1],10)),c>=30&&MediaStreamTrack.getSources(b)};return window.hasUserMedia()?(console.log("detecting camera"),void h(function(){console.log("setting camera"),n(0)})):void m({code:-1,msg:"Browser does not support getUserMedia."})},p=function(d){navigator.getMedia(d,k,m),c.addEventListener("canplay",function(){var d=b.width=a.videoWidth||320,e=b.height=0;if(!h){console.log("width : "+d+" videoElem.videoWidth : "+c.videoWidth+" "+a.videoHeight);var f=d/c.videoWidth;e=c.videoHeight*f||a.videoHeight,c.setAttribute("width",d),c.setAttribute("height",e),h=!0,l(),a.onStreaming&&a.onStreaming({video:c})}},!1)},q=function(){j(),c.remove()};a.$on("$destroy",j),a.$on("START_WEBCAM",o),a.$on("STOP_WEBCAM",q),o()}}});