"use strict";!function(){navigator.getMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,window.hasUserMedia=function(){return navigator.getMedia?!0:!1}}(),angular.module("webcam",[]).directive("webcam",["$window",function(){return{template:'<div class="webcam"></div>',restrict:"E",replace:!0,transclude:!0,scope:{onError:"&",onStream:"&",onStreaming:"&",getBytearray:"=",placeholder:"=",streamWidth:"=",streamHeight:"=",elementWidth:"=",elementHeight:"=",facing:"=",fps:"="},link:function(a,b){var c="https://raw.githubusercontent.com/coryalder/Interface-Elements/master/camera_switch.png",d=10,e=null,f=null,g=null,h=null,i=null,j=null,k={hasPlaceholder:!1,hasSwitchCamera:!0,fps:30,dims:{width:320,height:240}},l={isStreaming:!1,availableCameras:[],facing:{id:{front:-1,back:-1},"default":"back",hasFacing:function(){return!(-1==this.id.front&&-1==this.id.back)}},current:{id:0,stream:null,streamSpecs:{}},dims:{width:320,height:240}},m={aspectRatioElem:1,aspectRatioFeed:1,scale:1,renderRect:null},n=function(){if(s(),t(),a.placeholder){var c=document.createElement("img");c.setAttribute("class","webcam-loader"),c.src=a.placeholder,b.append(c)}if(u()){var d=function(){console.log("setting camera"),l.facing.hasFacing()&&(l.current.id=l.facing.id[l.facing.default]),w(l.current.id)};v(d)}},o=function(){p(),f.remove()},p=function(){l.current.stream&&"function"==typeof l.current.stream.stop&&l.current.stream.stop(),e&&window.clearInterval(e)},q=function(){var a=l.current.id,b=l.availableCameras;a++,a>=b.length&&(a=0),w(a)};a.getBytearray=function(){var a=h.getContext("2d");a.drawImage(f,0,0,h.width,h.height);var b=a.getImageData(0,0,h.width,h.height).data;return r(b)};var r=function(a){for(var b=new Uint8Array(a.length/4),c=0;c<a.length;c+=4)b[c>>2]=Math.floor(.2126*a[c]+.7152*a[c+1]+.0722*a[c+2]);return b},s=function(){a.streamWidth&&(l.dims.width=a.streamWidth),a.streamHeight&&(l.dims.height=a.streamHeight),a.elementWidth&&(k.dims.width=a.elementWidth),a.elementHeight&&(k.dims.height=a.elementHeight),!a.facing||"front"!==a.facing&&"back"!==a.facing||(l.facing.default=a.facing),a.fps&&(k.fps=a.fps),aspectRatioElem=k.dims.width/k.dims.height},t=function(){f=document.createElement("video"),f.setAttribute("class","webcam-live"),f.setAttribute("autoplay",""),h=document.createElement("canvas"),h.setAttribute("width",l.dims.width),h.setAttribute("height",l.dims.height),g=document.createElement("canvas"),g.setAttribute("width",k.dims.width),g.setAttribute("height",k.dims.height),g.onmousedown=B,b.append(g),k.hasSwitchCamera&&(j=document.createElement("img"),j.src=c)},u=function(){if(!window.hasUserMedia())return onFailure({code:-1,msg:"Browser does not support getUserMedia."}),!1;var a="";return navigator.webkitGetUserMedia&&(a=parseInt(navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./)[2],10)),navigator.mozGetUserMedia&&(a=parseInt(navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1],10)),a>=30?!0:!1},v=function(a){function b(b){l.availableCameras=[];for(var c=0;c<b.length;c++)"audio"!==b[c].kind&&(console.log(b[c]),"user"===b[c].facing?l.facing.id.front=l.availableCameras.length:"environment"===b[c].facing&&(l.facing.id.back=l.availableCameras.length),l.availableCameras.push(b[c]));a()}MediaStreamTrack.getSources(b)},w=function(a){var b=l.availableCameras;a="undefined"!=typeof a?a:0,console.log("message before validation"),(0>a||a>=b.length)&&(a=0),console.log("message after validation"),console.log("cameras : ",b,"using id : ",a);var c={};navigator.getUserMedia?c={video:{optional:[{sourceId:b[a].id}]}}:navigator.oGetUserMedia?c={video:{optional:[{sourceId:b[a].id}]}}:navigator.mozGetUserMedia?c={video:{optional:[{sourceId:b[a].id}]}}:navigator.webkitGetUserMedia?c={video:{optional:[{sourceId:b[a].id}]}}:navigator.msGetUserMedia&&(c={video:{optional:[{sourceId:b[a].id}]},audio:!1}),console.log("camera spec",c),l.current.streamSpec=c,l.current.id=a,x(c)},x=function(b){var c=function(b){if(l.current.stream=b,console.log(b),navigator.mozGetUserMedia)f.mozSrcObject=b;else{var c=window.URL||window.webkitURL;f.src=c.createObjectURL(b)}f.play(),a.onStream&&a.onStream({stream:b,video:f}),e=setInterval(z,1e3/k.fps)},d=function(b){C(),console&&console.log&&console.log("The following error occured: ",b),a.onError&&a.onError({err:b})};l.current.stream&&p(),navigator.getMedia(b,c,d),f.addEventListener("canplay",function(){l.isStreaming||(m.aspectRatioFeed=f.videoWidth/f.videoHeight,m.aspectRatioFeed!=m.aspectRatioElem&&A(),l.isStreaming=!0,C(),a.onStreaming&&a.onStreaming({video:f}))},!1)},y=0,z=function(){if(l.isStreaming){f.videoWidth!=y&&(A(),y=f.videoWidth);var a=g.getContext("2d"),b=m.renderRect?m.renderRect:{x:0,y:0,width:g.width,height:g.height};a.drawImage(f,b.x,b.y,b.width,b.height),k.hasSwitchCamera&&a.drawImage(j,g.width-d-j.width,d)}},A=function(){if(m.aspectRatioFeed=f.videoWidth/f.videoHeight,m.aspectRatioFeed<m.aspectRatioElem){var a=k.dims.width/f.videoWidth,b=f.videoHeight*a,c=-(b-k.dims.height)/2;m.renderRect={x:0,y:c,width:k.dims.width,height:b}}else if(m.aspectRatioFeed>m.aspectRatioElem){var a=k.dims.height/f.videoHeight,d=f.videoWidth*a,e=-(d-k.dims.width)/2;m.renderRect={x:e,y:0,width:d,height:k.dims.height}}},B=function(a){if(console.log(a),k.hasSwitchCamera){var b=g.width-d-j.width,c=b+j.width,e=d,f=e+j.height;a.layerX>b&&a.layerX<c&&a.layerY>e&&a.layerY<f&&(console.log("hit"),q())}},C=function(){console.log("removing placeholder"),i&&angular.element(i).remove()};a.$on("$destroy",p),a.$on("START_WEBCAM",n),a.$on("STOP_WEBCAM",o),n()}}}]);